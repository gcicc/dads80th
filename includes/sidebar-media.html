<script>
// Move chapter media panel into the right margin sidebar,
// reorder Photo Gallery above Soundtrack, and add Back to Top link
(function() {
  function setup() {
    var panel = document.querySelector('.chapter-media-panel');
    var sidebar = document.getElementById('quarto-margin-sidebar');
    if (!sidebar) return;

    // 1. Add "Back to top" link at the top of the TOC
    var toc = sidebar.querySelector('#TOC');
    if (toc) {
      var topLink = document.createElement('a');
      topLink.href = '#';
      topLink.className = 'back-to-top-link';
      topLink.textContent = 'Back to top';
      topLink.addEventListener('click', function(e) {
        e.preventDefault();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
      toc.insertBefore(topLink, toc.firstChild.nextSibling); // After the h2 heading
    }

    if (!panel) return;

    // 2. Reorder: put Photo Gallery callout before Soundtrack callout
    var callouts = panel.querySelectorAll('.callout');
    var photoCallout = null;
    var soundtrackCallout = null;
    for (var i = 0; i < callouts.length; i++) {
      var titleEl = callouts[i].querySelector('.callout-title-inner') ||
                    callouts[i].querySelector('.callout-header');
      var title = titleEl ? (titleEl.textContent || '') : '';
      if (title.indexOf('Photo') !== -1) photoCallout = callouts[i];
      if (title.indexOf('Soundtrack') !== -1) soundtrackCallout = callouts[i];
    }
    if (photoCallout && soundtrackCallout) {
      panel.insertBefore(photoCallout, soundtrackCallout);
    }

    // 3. Move the panel into the sidebar (after the TOC)
    sidebar.appendChild(panel);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setup);
  } else {
    setup();
  }
})();
</script>
