<!-- Life Journey Map â€” Leaflet.js interactive map for address history -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script>
// Load Leaflet.js from CDN
(function() {
  if (window.L) return;
  var tag = document.createElement('script');
  tag.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
  tag.onload = function() { window.dispatchEvent(new Event('leaflet-ready')); };
  var first = document.getElementsByTagName('script')[0];
  first.parentNode.insertBefore(tag, first);
})();

// Life Map controller
(function() {
  'use strict';

  // Embedded address data (avoids fetch/CORS issues on file:// and GitHub Pages)
  var ADDRESSES_DATA = null;

  // Phase colors matching era CSS
  var PHASE_COLORS = {
    'childhood':      '#008B8B',
    'military':       '#556B2F',
    'early-marriage':  '#800020',
    'shore-years':    '#B8860B',
    'retirement':     '#8B0000',
    'golden':         '#DAA520'
  };

  var PHASE_LABELS = {
    'childhood':      'Childhood (1946\u20131963)',
    'military':       'U.S. Air Force (1964\u20131969)',
    'early-marriage': 'Early Marriage (1969\u20131980)',
    'shore-years':    'Shore Years (1980\u20132000)',
    'retirement':     'Retirement (2000\u20132020)',
    'golden':         'Golden Years (2020\u2013Present)'
  };

  var TYPE_ICONS = {
    'home':     '\u{1F3E0}',
    'military': '\u2B50',
    'work':     '\u{1F4BC}',
    'landmark': '\u{1F4CD}',
    'church':   '\u26EA',
    'factory':  '\u{1F3ED}',
    'historic': '\u{1F5FD}',
    'school':   '\u{1F393}',
    'restaurant':'\u{1F355}',
    'beach':    '\u{1F3D6}'
  };

  function createIcon(phase, type, isLandmark) {
    var color = isLandmark ? '#555' : (PHASE_COLORS[phase] || '#333');
    var emoji = TYPE_ICONS[type] || TYPE_ICONS[isLandmark ? 'landmark' : 'home'];
    return L.divIcon({
      className: 'life-map-marker',
      html: '<div class="life-map-pin" style="background:' + color + ';">' +
            '<span class="life-map-emoji">' + emoji + '</span></div>',
      iconSize: [36, 36],
      iconAnchor: [18, 36],
      popupAnchor: [0, -36]
    });
  }

  function LifeMap(container) {
    this.container = container;
    this.map = null;
    this.markers = [];
    this.polyline = null;
    this.playing = false;
    this.playIndex = 0;
    this.playTimer = null;
    this.addressMarkers = [];
    this.landmarkMarkers = [];

    // Determine filter mode from CSS classes
    this.filterPhase = null;
    if (container.classList.contains('life-map-filter-childhood')) {
      this.filterPhase = 'childhood';
    } else if (container.classList.contains('life-map-filter-military')) {
      this.filterPhase = 'military';
    } else if (container.classList.contains('life-map-filter-shore')) {
      this.filterPhase = ['shore-years', 'retirement', 'golden'];
    } else if (container.classList.contains('life-map-filter-early-marriage')) {
      this.filterPhase = 'early-marriage';
    }

    this.showLandmarks = !this.filterPhase || this.filterPhase === 'childhood';
    this.showPlayButton = !this.filterPhase;
  }

  LifeMap.prototype.init = function(data) {
    ADDRESSES_DATA = data;
    var addresses = data.addresses || [];
    var landmarks = data.landmarks || [];

    // Filter addresses if needed
    if (this.filterPhase) {
      var fp = this.filterPhase;
      if (Array.isArray(fp)) {
        addresses = addresses.filter(function(a) { return fp.indexOf(a.phase) !== -1; });
        landmarks = landmarks.filter(function(l) {
          // Shore filter: include Shore landmarks
          return ['pete-eldas', 'point-pleasant', 'avon-by-the-sea', 'long-branch-hs', 'asbury-park-schools'].indexOf(l.id) !== -1;
        });
      } else if (fp === 'childhood') {
        addresses = addresses.filter(function(a) { return a.phase === 'childhood'; });
        // Include Bayonne landmarks
        landmarks = landmarks.filter(function(l) {
          return ['assumption-church', 'mt-carmel', 'maidenform', 'ellis-island'].indexOf(l.id) !== -1;
        });
      } else if (fp === 'military') {
        addresses = addresses.filter(function(a) { return a.phase === 'military'; });
        landmarks = [];
      } else {
        addresses = addresses.filter(function(a) { return a.phase === fp; });
        landmarks = [];
      }
    }

    // Sort by order
    addresses.sort(function(a, b) { return a.order - b.order; });

    // Create map
    this.map = L.map(this.container, {
      scrollWheelZoom: false,
      zoomControl: true
    });

    // OpenStreetMap tiles (free, no API key)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 18
    }).addTo(this.map);

    // Add address markers
    var coords = [];
    var self = this;
    for (var i = 0; i < addresses.length; i++) {
      var a = addresses[i];
      var icon = createIcon(a.phase, a.type, false);
      var popup = '<div class="life-map-popup">' +
        '<div class="life-map-popup-phase" style="background:' + (PHASE_COLORS[a.phase] || '#333') + ';">' +
        (PHASE_LABELS[a.phase] || a.phase) + '</div>' +
        '<strong>' + a.label + '</strong><br>' +
        '<span class="life-map-popup-years">' + a.years + '</span>' +
        (a.note ? '<br><em>' + a.note + '</em>' : '') +
        '</div>';

      var marker = L.marker([a.lat, a.lng], { icon: icon })
        .bindPopup(popup)
        .addTo(this.map);

      this.addressMarkers.push({ marker: marker, data: a });
      coords.push([a.lat, a.lng]);
    }

    // Add landmark markers
    for (var j = 0; j < landmarks.length; j++) {
      var lm = landmarks[j];
      var lmIcon = createIcon(null, lm.icon || 'landmark', true);
      var lmPopup = '<div class="life-map-popup">' +
        '<strong>' + lm.label + '</strong>' +
        (lm.note ? '<br><em>' + lm.note + '</em>' : '') +
        '</div>';

      var lmMarker = L.marker([lm.lat, lm.lng], { icon: lmIcon })
        .bindPopup(lmPopup)
        .addTo(this.map);

      this.landmarkMarkers.push(lmMarker);
      coords.push([lm.lat, lm.lng]);
    }

    // Draw polyline for address trajectory
    if (addresses.length > 1) {
      var lineCoords = addresses.map(function(a) { return [a.lat, a.lng]; });
      this.polyline = L.polyline(lineCoords, {
        color: '#8B0000',
        weight: 2,
        opacity: 0.5,
        dashArray: '8, 8'
      }).addTo(this.map);
    }

    // Fit bounds
    if (coords.length > 0) {
      this.map.fitBounds(coords, { padding: [40, 40], maxZoom: 14 });
    }

    // Add controls
    this.buildControls(addresses);
  };

  LifeMap.prototype.buildControls = function(addresses) {
    var self = this;

    var controlDiv = document.createElement('div');
    controlDiv.className = 'life-map-controls';

    // Play Journey button (full map only)
    if (this.showPlayButton && addresses.length > 1) {
      var playBtn = document.createElement('button');
      playBtn.className = 'life-map-btn life-map-play';
      playBtn.innerHTML = '\u25B6 Play Journey';
      playBtn.setAttribute('aria-label', 'Animate through all addresses');

      playBtn.addEventListener('click', function(e) {
        e.preventDefault();
        if (self.playing) {
          self.stopJourney();
          playBtn.innerHTML = '\u25B6 Play Journey';
          playBtn.classList.remove('active');
        } else {
          self.playJourney();
          playBtn.innerHTML = '\u25A0 Stop';
          playBtn.classList.add('active');
        }
      });

      controlDiv.appendChild(playBtn);
      this.playBtn = playBtn;

      // Track counter
      var counter = document.createElement('span');
      counter.className = 'life-map-counter';
      counter.textContent = '';
      controlDiv.appendChild(counter);
      this.counterEl = counter;
    }

    // Reset view button
    var resetBtn = document.createElement('button');
    resetBtn.className = 'life-map-btn';
    resetBtn.innerHTML = '\u{1F5FA} Reset View';
    resetBtn.addEventListener('click', function(e) {
      e.preventDefault();
      var allCoords = self.addressMarkers.map(function(m) {
        return [m.data.lat, m.data.lng];
      });
      self.landmarkMarkers.forEach(function(m) {
        allCoords.push([m.getLatLng().lat, m.getLatLng().lng]);
      });
      if (allCoords.length > 0) {
        self.map.fitBounds(allCoords, { padding: [40, 40], maxZoom: 14 });
      }
    });
    controlDiv.appendChild(resetBtn);

    // Insert controls before the map container
    this.container.parentNode.insertBefore(controlDiv, this.container.nextSibling);
  };

  LifeMap.prototype.playJourney = function() {
    this.playing = true;
    this.playIndex = 0;
    this.advanceJourney();
  };

  LifeMap.prototype.advanceJourney = function() {
    if (!this.playing || this.playIndex >= this.addressMarkers.length) {
      this.stopJourney();
      return;
    }

    var item = this.addressMarkers[this.playIndex];
    var marker = item.marker;
    var data = item.data;

    // Fly to this location
    var zoomLevel = data.phase === 'military' ? 5 : 12;
    // If jumping continents, zoom out first
    if (this.playIndex > 0) {
      var prev = this.addressMarkers[this.playIndex - 1].data;
      var dist = Math.abs(data.lat - prev.lat) + Math.abs(data.lng - prev.lng);
      if (dist > 10) zoomLevel = 4;
      else if (dist > 2) zoomLevel = 8;
    }

    this.map.flyTo([data.lat, data.lng], zoomLevel, { duration: 2 });

    // Open popup after fly animation
    var self = this;
    setTimeout(function() {
      marker.openPopup();
    }, 2200);

    // Update counter
    if (this.counterEl) {
      this.counterEl.textContent = (this.playIndex + 1) + ' / ' + this.addressMarkers.length +
        ' \u2014 ' + data.years;
    }

    this.playIndex++;

    // Schedule next
    this.playTimer = setTimeout(function() {
      self.advanceJourney();
    }, 5000);
  };

  LifeMap.prototype.stopJourney = function() {
    this.playing = false;
    if (this.playTimer) {
      clearTimeout(this.playTimer);
      this.playTimer = null;
    }
    if (this.playBtn) {
      this.playBtn.innerHTML = '\u25B6 Play Journey';
      this.playBtn.classList.remove('active');
    }
    if (this.counterEl) {
      this.counterEl.textContent = '';
    }
  };

  // --- Initialization ---

  function initLifeMaps() {
    var containers = document.querySelectorAll('.life-map');
    if (containers.length === 0) return;

    // Fetch the addresses data
    // Try relative paths that work in Quarto book structure
    var paths = [
      'data/addresses.json',
      '../data/addresses.json',
      '../../data/addresses.json'
    ];

    function tryFetch(pathIndex) {
      if (pathIndex >= paths.length) {
        // Fallback: use embedded data if fetch fails
        console.warn('LifeMap: Could not load addresses.json from any path');
        return;
      }

      fetch(paths[pathIndex])
        .then(function(resp) {
          if (!resp.ok) throw new Error('Not found');
          return resp.json();
        })
        .then(function(data) {
          for (var i = 0; i < containers.length; i++) {
            var lm = new LifeMap(containers[i]);
            lm.init(data);
          }
        })
        .catch(function() {
          tryFetch(pathIndex + 1);
        });
    }

    tryFetch(0);
  }

  function onReady() {
    if (window.L) {
      initLifeMaps();
    } else {
      window.addEventListener('leaflet-ready', initLifeMaps);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', onReady);
  } else {
    onReady();
  }
})();
</script>
