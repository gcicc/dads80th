<script>
// Photo Slideshow — converts .photo-slideshow divs into interactive carousels
// LAZY: only initializes when the parent callout is expanded
// Features: Play/Pause autoplay, click-to-enlarge lightbox
(function() {

  // --- Lightbox overlay (shared across all slideshows) ---
  var lightbox = document.createElement('div');
  lightbox.className = 'slideshow-lightbox';
  lightbox.innerHTML = '<div class="slideshow-lightbox-backdrop"></div>' +
    '<img class="slideshow-lightbox-img" alt="">' +
    '<button class="slideshow-lightbox-close" aria-label="Close">&times;</button>' +
    '<div class="slideshow-lightbox-caption"></div>';
  document.body.appendChild(lightbox);

  var lbImg = lightbox.querySelector('.slideshow-lightbox-img');
  var lbCaption = lightbox.querySelector('.slideshow-lightbox-caption');

  function openLightbox(src, caption) {
    lbImg.src = src;
    lbCaption.textContent = caption || '';
    lightbox.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function closeLightbox() {
    lightbox.classList.remove('active');
    document.body.style.overflow = '';
  }

  lightbox.querySelector('.slideshow-lightbox-backdrop').addEventListener('click', closeLightbox);
  lightbox.querySelector('.slideshow-lightbox-close').addEventListener('click', closeLightbox);
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && lightbox.classList.contains('active')) closeLightbox();
  });

  function initSlideshow(container) {
    if (container.dataset.slideshowInit) return;
    container.dataset.slideshowInit = '1';

    var images = container.querySelectorAll('img');
    if (images.length === 0) return;

    // Extract data from Quarto-rendered images
    var slides = [];
    images.forEach(function(img) {
      slides.push({
        src: img.getAttribute('src') || img.src,
        alt: img.alt || '',
        caption: img.alt || ''
      });
    });

    // Build slideshow HTML — only first image loads eagerly, rest are lazy
    var html = '<div class="slide-container">';
    html += '<button class="slideshow-nav prev" aria-label="Previous">&lsaquo;</button>';
    html += '<button class="slideshow-nav next" aria-label="Next">&rsaquo;</button>';
    html += '<span class="slideshow-counter">1 / ' + slides.length + '</span>';
    html += '<button class="slideshow-play-btn" aria-label="Play slideshow" title="Auto-play">&#9654;</button>';
    slides.forEach(function(s, i) {
      if (i === 0) {
        html += '<img src="' + s.src + '" alt="' + s.alt.replace(/"/g, '&quot;') + '" class="active">';
      } else {
        html += '<img data-src="' + s.src + '" alt="' + s.alt.replace(/"/g, '&quot;') + '">';
      }
    });
    html += '</div>';
    html += '<div class="slideshow-caption">' + (slides[0].caption || '') + '</div>';
    html += '<div class="slideshow-thumbs">';
    slides.forEach(function(s, i) {
      // Thumbs are small — load first few eagerly, rest lazy
      if (i < 5) {
        html += '<img src="' + s.src + '" alt="thumb"' +
                (i === 0 ? ' class="active"' : '') +
                ' data-index="' + i + '">';
      } else {
        html += '<img data-src="' + s.src + '" alt="thumb"' +
                ' data-index="' + i + '">';
      }
    });
    html += '</div>';

    container.innerHTML = html;

    // Slideshow logic
    var current = 0;
    var allSlides = container.querySelectorAll('.slide-container img');
    var thumbs = container.querySelectorAll('.slideshow-thumbs img');
    var caption = container.querySelector('.slideshow-caption');
    var counter = container.querySelector('.slideshow-counter');
    var playBtn = container.querySelector('.slideshow-play-btn');
    var autoTimer = null;
    var playing = false;

    function ensureLoaded(img) {
      if (!img.src && img.dataset.src) {
        img.src = img.dataset.src;
      }
    }

    function goTo(idx) {
      if (idx < 0) idx = slides.length - 1;
      if (idx >= slides.length) idx = 0;
      allSlides[current].classList.remove('active');
      thumbs[current].classList.remove('active');
      current = idx;
      // Load current slide + next slide + thumb
      ensureLoaded(allSlides[current]);
      ensureLoaded(thumbs[current]);
      if (current + 1 < slides.length) {
        ensureLoaded(allSlides[current + 1]);
        ensureLoaded(thumbs[current + 1]);
      }
      allSlides[current].classList.add('active');
      thumbs[current].classList.add('active');
      caption.textContent = slides[current].caption;
      counter.textContent = (current + 1) + ' / ' + slides.length;
      // Scroll thumb into view (within thumbs container only, not the page)
      var thumbStrip = thumbs[current].parentElement;
      var thumbLeft = thumbs[current].offsetLeft - thumbStrip.offsetLeft;
      var thumbCenter = thumbLeft - (thumbStrip.clientWidth / 2) + (thumbs[current].clientWidth / 2);
      thumbStrip.scrollTo({ left: thumbCenter, behavior: 'smooth' });
    }

    function startAutoplay() {
      if (autoTimer) clearInterval(autoTimer);
      autoTimer = setInterval(function() { goTo(current + 1); }, 4000);
      playing = true;
      playBtn.innerHTML = '&#9646;&#9646;'; // pause icon
      playBtn.title = 'Pause';
      playBtn.classList.add('playing');
    }

    function stopAutoplay() {
      if (autoTimer) { clearInterval(autoTimer); autoTimer = null; }
      playing = false;
      playBtn.innerHTML = '&#9654;'; // play icon
      playBtn.title = 'Auto-play';
      playBtn.classList.remove('playing');
    }

    playBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      if (playing) { stopAutoplay(); } else { startAutoplay(); }
    });

    container.querySelector('.prev').addEventListener('click', function() { goTo(current - 1); });
    container.querySelector('.next').addEventListener('click', function() { goTo(current + 1); });

    thumbs.forEach(function(thumb) {
      thumb.addEventListener('click', function() {
        goTo(parseInt(this.dataset.index));
      });
    });

    // Click on main slide image opens lightbox
    allSlides.forEach(function(img, i) {
      img.style.cursor = 'pointer';
      img.addEventListener('click', function() {
        var src = img.src || img.dataset.src;
        openLightbox(src, slides[i].caption);
      });
    });

    // Keyboard navigation
    container.addEventListener('keydown', function(e) {
      if (e.key === 'ArrowLeft') goTo(current - 1);
      if (e.key === 'ArrowRight') goTo(current + 1);
    });
    container.setAttribute('tabindex', '0');
  }

  // For each slideshow, wait until its parent callout is expanded before initializing
  document.querySelectorAll('.photo-slideshow').forEach(function(container) {
    var callout = container.closest('.callout');
    if (!callout) {
      // No callout parent — init immediately
      initSlideshow(container);
      return;
    }

    // Check if callout is already expanded
    var body = callout.querySelector('.callout-body-container');
    if (body && body.offsetHeight > 0 && getComputedStyle(body).display !== 'none') {
      initSlideshow(container);
      return;
    }

    // Wait for callout expand
    var header = callout.querySelector('.callout-header');
    if (header) {
      header.addEventListener('click', function onExpand() {
        setTimeout(function() { initSlideshow(container); }, 300);
        header.removeEventListener('click', onExpand);
      });
    }

    // Also watch via MutationObserver as fallback
    var observer = new MutationObserver(function() {
      var b = callout.querySelector('.callout-body-container');
      if (b && b.offsetHeight > 0) {
        initSlideshow(container);
        observer.disconnect();
      }
    });
    observer.observe(callout, { attributes: true, childList: true, subtree: true });
  });
})();
</script>
